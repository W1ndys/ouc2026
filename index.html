<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨åˆè¯•å½•åˆ†ä¸æ’å</title>
    <script src="https://cdn.jsdelivr.net/npm/hydrogen-js-sdk/dist/Bmob-2.5.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; padding: 20px 10px; margin: 0;}
        .container { 
            background-color: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            max-width: 450px; 
            width: 90%;       
            box-sizing: border-box; 
        }
        h2 { text-align: center; color: #0056b3; font-size: 20px; line-height: 1.4; margin-bottom: 5px;}
        .notice { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; font-size: 12px; color: #856404; margin-bottom: 20px; border-radius: 4px;}
        .step-box { display: none; }
        .active-step { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #444; font-weight: bold; font-size: 14px;}
        .sub-label { font-size: 12px; color: #888; font-weight: normal; margin-left: 5px;}
        input[type="number"], select { 
            width: 100%; padding: 10px; border: 1px solid #ccc; 
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        button { width: 100%; padding: 12px; background-color: #0056b3; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 15px; font-weight: bold; transition: background-color 0.3s;}
        button:hover { background-color: #004494; }
        button:disabled { background-color: #999 !important; cursor: not-allowed; }
        
        .rank-item { background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-left: 5px solid #0056b3; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;}
        .rank-num { font-size: 18px; font-weight: bold; color: #e74c3c; width: 40px;}
        .rank-detail { flex-grow: 1; }
        
        /* ç™»å½•é¡µä¸“å±æ ·å¼ */
        .login-box { text-align: center; padding: 20px 0; }
        .login-icon { font-size: 40px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨<br>åˆè¯•æˆç»©å½•å…¥ä¸æ’å</h2>
    
    <div class="notice">
        <strong>âš ï¸ é˜²åˆ·æ¦œæ ¸å®å£°æ˜ï¼š</strong><br>
        ä¸ºä¿è¯æ¦œå•çº¯æ´æ€§ï¼Œç³»ç»Ÿå·²å¼€å¯æš—è®¿æœºåˆ¶ã€‚ç®¡ç†å‘˜å°†é€šè¿‡é¢„ç•™çš„QQå·æ·»åŠ æ ¸éªŒã€å‡†è€ƒè¯ã€‘ä¸ã€æˆç»©æˆªå›¾ã€‘ã€‚æ— æ³•æä¾›è€…ï¼Œæˆç»©å°†è¢«ç›´æ¥å‰”é™¤ã€‚
    </div>

    <div id="step1" class="step-box active-step">
        <div class="login-box">
            <div class="login-icon">ğŸ§</div>
            <h3 style="color:#333; margin-bottom: 20px;">èº«ä»½é€šè¡Œè¯</h3>
            <div class="input-group" style="text-align: left;">
                <label>è¯·è¾“å…¥ä½ çš„çœŸå® QQ å·</label>
                <input type="number" id="loginQQ" placeholder="è¾“å…¥QQå·è¿›å…¥ç³»ç»Ÿ / æ‰¾å›æˆç»©">
            </div>
            <button id="loginBtn" onclick="loginWithQQ()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </div>

    <div id="step2" class="step-box">
        <div style="background:#e8f4f8; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px; color:#0056b3; text-align:center;">
            å½“å‰ç™»å½•èº«ä»½ï¼šQQ <strong id="displayQQ"></strong>
        </div>

        <div class="input-group">
            <label>æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘</label>
            <select id="majorSelect">
                <option value="" disabled selected>è¯·é€‰æ‹©ä½ çš„ä¸“ä¸šä¸æ–¹å‘...</option>
                <optgroup label="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
                    <option value="081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†)">081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯†">
                    <option value="0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†)">0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="è®¡ç®—æœºæŠ€æœ¯">
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)">085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)</option>
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)">085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)</option>
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)">085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)</option>
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)">085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)</option>
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)">085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)</option>
                    <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†)">085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="è½¯ä»¶å·¥ç¨‹">
                    <option value="085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†)">085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="äººå·¥æ™ºèƒ½">
                    <option value="085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)">085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)</option>
                    <option value="085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)">085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)</option>
                    <option value="085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†)">085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹">
                    <option value="085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†)">085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
                <optgroup label="ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨">
                    <option value="085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†)">085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†æ–¹å‘)</option>
                </optgroup>
            </select>
        </div>

        <div class="input-group"><label>æ”¿æ²»</label><input type="number" id="sub1" placeholder="è¾“å…¥åˆ†æ•°"></div>
        <div class="input-group"><label>è‹±è¯­</label><input type="number" id="sub2" placeholder="è¾“å…¥åˆ†æ•°"></div>
        <div class="input-group"><label>æ•°å­¦</label><input type="number" id="sub3" placeholder="è¾“å…¥åˆ†æ•°"></div>
        <div class="input-group"><label>ä¸“ä¸šè¯¾(408)</label><input type="number" id="sub4" placeholder="è¾“å…¥åˆ†æ•°"></div>
        
        <button id="submitBtn" onclick="submitCloudScore()">ç«‹ä¸‹èª“è¨€ï¼Œæäº¤æˆç»©</button>
    </div>

    <div id="step3" class="step-box">
        <h3 style="color:#333; border-bottom: 2px solid #eee; padding-bottom: 8px; font-size: 16px; margin-bottom: 10px;">å®æ—¶æ€»åˆ†æ’è¡Œæ¦œ</h3>
        
        <div class="input-group" style="background:#e9f2fb; padding:10px; border-radius:6px;">
            <label style="color:#0056b3; font-size:12px; margin-bottom: 4px;">å½“å‰æ¦œå•ä¸“ä¸šæ–¹å‘ï¼š</label>
            <select id="rankFilter" onchange="fetchRanking()" style="padding: 6px; font-size: 13px;"></select>
        </div>

        <div id="rankingList" style="margin-top: 15px; font-size: 14px;">æ­£åœ¨åŠªåŠ›ä»äº‘ç«¯æ‹‰å–æ’åæ•°æ®...</div>
        
        <button id="modifyBtn" onclick="goToModify()" style="background-color: #e67e22; margin-top: 20px;">å‘ç°å¡«é”™ï¼Ÿè¿”å›ä¿®æ”¹æˆç»©</button>
        <button onclick="logout()" style="background-color: #7f8c8d; margin-top: 10px;">å®‰å…¨é€€å‡ºå½“å‰ QQ</button>
    </div>
</div>

<script>
    // Bmob å¯†é’¥åˆå§‹åŒ–
    Bmob.initialize("3214f8afece0391a", "ouc2026score1234");
    document.getElementById('rankFilter').innerHTML = document.getElementById('majorSelect').innerHTML;

    // å…¨å±€å˜é‡ç®¡ç†ç”¨æˆ·çŠ¶æ€ï¼ˆçº¯å†…å­˜ï¼Œåˆ·æ–°å³ä¸¢ï¼Œç»å¯¹ä¸ç¼“å­˜åˆ°ç¡¬ç›˜ï¼‰
    let globalUserQQ = ""; 
    let globalRecordId = ""; 

    function showStep(stepNumber) {
        document.querySelectorAll('.step-box').forEach(el => el.classList.remove('active-step'));
        document.getElementById('step' + stepNumber).classList.add('active-step');
    }

    // ç™»å½•æ ¸å¿ƒé€»è¾‘ï¼šåªè®¤äº‘ç«¯æ•°æ®ï¼Œä¸è®¤æœ¬åœ°ï¼
    function loginWithQQ() {
        let qq = document.getElementById('loginQQ').value;
        if(!qq || qq.length < 5) { alert("è¯·è¾“å…¥æ­£ç¡®çš„QQå·ï¼"); return; }

        let btn = document.getElementById('loginBtn');
        btn.innerText = "æ­£åœ¨æ ¸å¯¹äº‘ç«¯æ¡£æ¡ˆ...";
        btn.disabled = true;

        const query = Bmob.Query("ScoreRecord");
        query.equalTo("qq", "==", qq);
        query.find().then(res => {
            globalUserQQ = qq;
            document.getElementById('displayQQ').innerText = qq;

            // åªè¦äº‘ç«¯æŸ¥åˆ°æ•°æ®ï¼Œå°±æ˜¯è€ç”¨æˆ·
            if (res.length > 0) {
                let myData = res[0];
                globalRecordId = myData.objectId; 
                
                document.getElementById('majorSelect').value = myData.major;
                document.getElementById('sub1').value = myData.s1;
                document.getElementById('sub2').value = myData.s2;
                document.getElementById('sub3').value = myData.s3;
                document.getElementById('sub4').value = myData.s4;

                document.getElementById('rankFilter').value = myData.major;
                showStep(3);
                fetchRanking();
            } 
            // åªè¦äº‘ç«¯æ²¡æŸ¥åˆ°ï¼ˆæˆ–è€…æ˜¯è¢«ç®¡ç†å‘˜åˆ é™¤äº†ï¼‰ï¼Œç»Ÿä¸€æŒ‰æ–°ç”¨æˆ·å¤„ç†ï¼
            else {
                globalRecordId = ""; 
                // æ¸…ç©ºè¡¨æ ¼ï¼Œé˜²æ­¢ä¸Šä¸€ä¸ªäººçš„ç—•è¿¹ä¸²åœº
                document.getElementById('majorSelect').value = "";
                document.getElementById('sub1').value = "";
                document.getElementById('sub2').value = "";
                document.getElementById('sub3').value = "";
                document.getElementById('sub4').value = "";
                
                showStep(2);
            }
            
            btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
            btn.disabled = false;
        }).catch(err => {
            alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
            btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
            btn.disabled = false;
        });
    }

    function goToModify() {
        document.getElementById('submitBtn').innerText = "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤";
        document.getElementById('submitBtn').disabled = false;
        showStep(2);
    }

    function submitCloudScore() {
        let major = document.getElementById('majorSelect').value;
        let v1 = document.getElementById('sub1').value;
        let v2 = document.getElementById('sub2').value;
        let v3 = document.getElementById('sub3').value;
        let v4 = document.getElementById('sub4').value;

        if(!major) { alert("è¯·é€‰æ‹©æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘ï¼"); return; }
        if(v1 === '' || v2 === '' || v3 === '' || v4 === '') { alert("æ¯ä¸€ç§‘æˆç»©éƒ½å¿…é¡»å¡«å†™å“¦ï¼"); return; }
        
        let s1 = Number(v1); let s2 = Number(v2); let s3 = Number(v3); let s4 = Number(v4);
        let total = s1 + s2 + s3 + s4;

        let btn = document.getElementById('submitBtn');
        btn.innerText = "æ•°æ®è·¨æµ·ä¼ è¾“ä¸­...";
        btn.disabled = true;

        const query = Bmob.Query('ScoreRecord');
        // å¦‚æœæœ‰äº‘ç«¯ IDï¼Œå°±æ‰§è¡Œæ›´æ–°ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±æ‰§è¡Œæ–°å»º
        if (globalRecordId) {
            query.set('id', globalRecordId); 
        }
        query.set("qq", globalUserQQ); 
        query.set("major", major);
        query.set("s1", s1);
        query.set("s2", s2);
        query.set("s3", s3);
        query.set("s4", s4);
        query.set("total", total);
        
        query.save().then(res => {
            if(!globalRecordId) {
                globalRecordId = res.objectId; 
                alert("åˆè¯•æˆç»©å½•å…¥æˆåŠŸï¼");
            } else {
                alert("æˆç»©å·²æˆåŠŸæ›´æ–°ï¼");
            }
            
            document.getElementById('rankFilter').value = major;
            showStep(3);
            fetchRanking();
        }).catch(err => {
            alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€");
            btn.innerText = globalRecordId ? "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤" : "ç«‹ä¸‹èª“è¨€ï¼Œæäº¤æˆç»©";
            btn.disabled = false;
        });
    }

    function fetchRanking() {
        let selectedMajor = document.getElementById('rankFilter').value;
        let rankDiv = document.getElementById('rankingList');
        rankDiv.innerHTML = "æ­£åœ¨æ‹‰å– " + selectedMajor + " çš„æ’å...";

        const query = Bmob.Query('ScoreRecord');
        query.equalTo("major", "==", selectedMajor);
        query.order("-total"); 
        query.limit(100); 
        
        query.find().then(records => {
            let htmlStr = "";
            if(records.length === 0) {
                rankDiv.innerHTML = `<div style="text-align:center; color:#999; margin-top:20px;">è¯¥æ–¹å‘ç›®å‰è¿˜æ²¡æœ‰äººå½•å…¥æˆç»©ï¼Œå¿«æ¥æŠ¢å æ²™å‘ï¼</div>`;
                return;
            }

            records.forEach((item, index) => {
                // åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰ç™»å½•çš„ QQ å·ï¼Œé«˜äº®æ˜¾ç¤ºè‡ªå·±çš„æˆç»©
                let isMe = (item.qq === globalUserQQ);
                let bgStyle = isMe ? "background: #fff3cd; border-left: 5px solid #f39c12;" : "";
                let meTag = isMe ? `<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">æˆ‘</span>` : "";

                htmlStr += `
                    <div class="rank-item" style="${bgStyle}">
                        <div class="rank-num">#${index + 1}</div>
                        <div class="rank-detail">
                            <strong>æ€»åˆ†ï¼š<span style="color:#e74c3c; font-size:16px;">${item.total}</span></strong> ${meTag}<br>
                            <span style="font-size:12px; color:#555;">æ”¿:${item.s1} | è‹±:${item.s2} | æ•°:${item.s3} | 408:${item.s4}</span>
                        </div>
                    </div>
                `;
            });
            rankDiv.innerHTML = htmlStr;
        }).catch(err => {
            rankDiv.innerHTML = "äº‘ç«¯æ•°æ®æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
        });
    }

    // é€€å‡ºæ¸…ç©ºå†…å­˜çŠ¶æ€ï¼Œå›å½’åˆå§‹
    function logout() {
        globalUserQQ = "";
        globalRecordId = "";
        document.getElementById('loginQQ').value = "";
        showStep(1);
    }
</script>

</body>
</html>
