<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·å¤§26ä¿¡æ¯/å“è¶Šåˆè¯•å½•åˆ†ä¸æ’å</title>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f4f7f6;
        display: flex;
        justify-content: center;
        padding: 20px 10px;
        margin: 0;
      }
      .container {
        background-color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        width: 95%;
        box-sizing: border-box;
      }
      h2 {
        text-align: center;
        color: #0056b3;
        font-size: 20px;
        line-height: 1.4;
        margin-bottom: 5px;
      }
      .notice {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        font-size: 12px;
        color: #856404;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .step-box {
        display: none;
      }
      .active-step {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #444;
        font-weight: bold;
        font-size: 14px;
      }
      .sub-label {
        font-size: 12px;
        color: #888;
        font-weight: normal;
        margin-left: 5px;
      }
      input[type="number"],
      input[type="text"],
      input[type="file"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
      }
      button {
        width: 100%;
        padding: 12px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #004494;
      }
      button:disabled {
        background-color: #999 !important;
        cursor: not-allowed;
      }
      .rank-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 5px solid #0056b3;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .rank-num {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
        width: 40px;
      }
      .rank-detail {
        flex-grow: 1;
      }
      .login-box {
        text-align: center;
        padding: 20px 0;
      }
      .login-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }
      .group-divider {
        background-color: #e9ecef;
        font-weight: bold;
        color: #0056b3;
        text-align: center;
      }
      /* ç»Ÿè®¡çœ‹æ¿æ ·å¼ */
      .stats-banner {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        font-size: 13px;
        font-weight: bold;
        border: 1px solid #c3e6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ä¸­å›½æµ·æ´‹å¤§å­¦26çº§åˆè¯•æˆç»©<br />ä¿¡æ¯å­¦éƒ¨ & å“è¶Šå·¥ç¨‹å¸ˆå­¦é™¢</h2>

      <div class="notice">
        <strong>âš ï¸ ä¸¥æ ¼å®¡æ ¸å£°æ˜ï¼š</strong><br />
        ç³»ç»Ÿå·²å¼€å¯åŒç›²å®¡æ ¸ã€‚ç®¡ç†å‘˜å°†äººå·¥æ ¸å¯¹ã€å‡†è€ƒè¯ã€‘ä¸ã€æŸ¥åˆ†æˆªå›¾ã€‘ã€‚<strong
          >ä»…å®¡æ ¸é€šè¿‡çš„åŒå­¦å¯è§£é”å¤§ç›˜ç»Ÿè®¡ä¸æ’åã€‚</strong
        >
      </div>

      <div id="step1" class="step-box active-step">
        <div class="login-box">
          <div class="login-icon">ğŸ§</div>
          <h3 style="color: #333; margin-bottom: 20px">èº«ä»½é€šè¡Œè¯</h3>
          <div class="input-group" style="text-align: left">
            <label>è¯·è¾“å…¥ä½ çš„çœŸå® QQ å·</label>
            <input type="text" id="loginQQ" placeholder="è¾“å…¥QQå·è¿›å…¥ç³»ç»Ÿ" />
          </div>
          <button id="loginBtn" onclick="loginWithQQ()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
      </div>

      <div id="step2" class="step-box">
        <div
          style="
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #0056b3;
            text-align: center;
          "
        >
          å½“å‰ç™»å½•èº«ä»½ï¼šQQ <strong id="displayQQ"></strong>
        </div>
        <div class="input-group">
          <label
            >å‡†è€ƒè¯å·
            <span class="sub-label">(ä»…ç”¨äºå®˜æ–¹æ ¸å¯¹ï¼Œç»ä¸å…¬å¼€)</span></label
          >
          <input type="text" id="ticketNum" placeholder="è¯·è¾“å…¥15ä½å‡†è€ƒè¯å·" />
        </div>
        <div class="input-group">
          <label>æŠ¥è€ƒå­¦é™¢ä¸æ–¹å‘</label>
          <select id="majorSelect">
            <option value="" disabled selected>è¯·é€‰æ‹©ä½ çš„æŠ¥è€ƒæ–¹å‘...</option>
            <option disabled class="group-divider">
              â€”â€” ä¿¡æ¯å­¦éƒ¨ (11408 / 22408) â€”â€”
            </option>
            <option value="[ä¿¡æ¯] 081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†)">
              [ä¿¡æ¯] 081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (å­¦ç¡•)
            </option>
            <option value="[ä¿¡æ¯] 0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†)">
              [ä¿¡æ¯] 0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (å­¦ç¡•)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (01æ–¹å‘)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (03è”åŸ¹)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)
            </option>
            <option value="[ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†)">
              [ä¿¡æ¯] 085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)
            </option>
            <option value="[ä¿¡æ¯] 085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†)">
              [ä¿¡æ¯] 085405 è½¯ä»¶å·¥ç¨‹
            </option>
            <option value="[ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)">
              [ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (01æ–¹å‘)
            </option>
            <option value="[ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)">
              [ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)
            </option>
            <option value="[ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†)">
              [ä¿¡æ¯] 085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†æ–¹å‘)
            </option>

            <option disabled class="group-divider">
              â€”â€” å“è¶Šå·¥ç¨‹å¸ˆå­¦é™¢ (22408) â€”â€”
            </option>
            <option value="[å“è¶Š] 085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†)">
              [å“è¶Š] 085404 è®¡ç®—æœºæŠ€æœ¯
            </option>
            <option value="[å“è¶Š] 085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†)">
              [å“è¶Š] 085405 è½¯ä»¶å·¥ç¨‹
            </option>
            <option value="[å“è¶Š] 085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†)">
              [å“è¶Š] 085410 äººå·¥æ™ºèƒ½
            </option>
            <option value="[å“è¶Š] 085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†)">
              [å“è¶Š] 085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹
            </option>
            <option value="[å“è¶Š] 085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†)">
              [å“è¶Š] 085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨
            </option>
          </select>
        </div>
        <div class="input-group">
          <label>æ”¿æ²»</label
          ><input type="number" id="sub1" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>è‹±è¯­</label
          ><input type="number" id="sub2" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>æ•°å­¦</label
          ><input type="number" id="sub3" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>ä¸“ä¸šè¯¾(408)</label
          ><input type="number" id="sub4" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>

        <div
          class="input-group"
          style="
            background: #fff9e6;
            padding: 10px;
            border-radius: 6px;
            border: 1px dashed #f39c12;
          "
        >
          <label style="color: #d35400"
            >ç ”æ‹›ç½‘æŸ¥åˆ†æˆªå›¾ <span id="imgRequireTip" class="sub-label"></span
          ></label>
          <input
            type="file"
            id="scoreImage"
            accept="image/png, image/jpeg, image/jpg"
            onchange="uploadImage()"
          />
          <div style="font-size: 11px; color: #888; margin-top: 5px">
            åŒ…å«å‡†è€ƒè¯å·å’Œåˆ†æ•°çš„å®Œæ•´æˆªå›¾ï¼Œå®¡æ ¸å”¯ä¸€å‡­è¯ã€‚
          </div>
          <div id="uploadStatus" style="font-size: 11px; margin-top: 5px; display: none"></div>
        </div>
        <button id="submitBtn" onclick="submitCloudScore()">
          æäº¤æ•°æ®ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
        </button>
      </div>

      <div id="step3" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          ğŸ“Š å®æ—¶ç»Ÿè®¡æ’è¡Œæ¦œ
        </h3>

        <div
          class="input-group"
          style="background: #e9f2fb; padding: 10px; border-radius: 6px"
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ç»Ÿè®¡èŒƒå›´ï¼š</label
          >
          <select
            id="rankFilter"
            onchange="fetchRanking()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div id="statsBanner"></div>

        <div id="rankingList" style="margin-top: 15px; font-size: 14px">
          æ­£åœ¨åŠªåŠ›æ‹‰å–å®¡æ ¸æ•°æ®...
        </div>

        <button
          id="modifyBtn"
          onclick="goToModify()"
          style="background-color: #e67e22; margin-top: 20px"
        >
          å‘ç°å¡«é”™ï¼Ÿè¿”å›ä¿®æ”¹æˆç»©
        </button>
        <button
          onclick="showCharts()"
          style="background-color: #27ae60; margin-top: 10px"
        >
          æŸ¥çœ‹æœ¬æ¦œå•è¶‹åŠ¿å›¾è¡¨
        </button>
        <button
          onclick="logout()"
          style="background-color: #7f8c8d; margin-top: 10px"
        >
          å®‰å…¨é€€å‡ºå½“å‰ QQ
        </button>
      </div>

      <div id="step4" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          æˆç»©åˆ†å¸ƒå›¾è¡¨
        </h3>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ç»Ÿè®¡èŒƒå›´ï¼š</label
          >
          <select
            id="chartMajorSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >æŸ¥çœ‹å…·ä½“ç§‘ç›®ï¼š</label
          >
          <select
            id="chartSubjectSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          >
            <option value="total">æ€»åˆ†</option>
            <option value="s1">æ”¿æ²»</option>
            <option value="s2">è‹±è¯­</option>
            <option value="s3">æ•°å­¦</option>
            <option value="s4">ä¸“ä¸šè¯¾(408)</option>
          </select>
        </div>

        <div
          id="chartContainer"
          style="width: 100%; height: 400px; margin-top: 20px; min-width: 300px"
        ></div>
        <button
          onclick="showStep(3)"
          style="background-color: #7f8c8d; margin-top: 20px"
        >
          è¿”å›æ’åé¡µé¢
        </button>
      </div>

      <div id="step5" class="step-box">
        <div style="text-align: center; padding: 20px 10px">
          <div style="font-size: 60px; margin-bottom: 10px">â³</div>
          <h3 style="color: #e67e22; margin-bottom: 15px">
            æ¡£æ¡ˆæ­£åœ¨ç«é€Ÿå®¡æ ¸ä¸­...
          </h3>
          <div
            style="
              font-size: 13px;
              color: #555;
              line-height: 1.6;
              background: #fdf2e9;
              padding: 15px;
              border-radius: 8px;
              text-align: left;
            "
          >
            ä¸ºä¿è¯æ¯ä½åŒå­¦çœ‹åˆ°çš„åˆ†æ•°ç»å¯¹çœŸå®ï¼š<br /><br />
            1. ç®¡ç†å‘˜æ­£åœ¨äººå·¥æ¯”å¯¹ä½ çš„<b>æŸ¥åˆ†æˆªå›¾</b>ä¸<b>å¡«æŠ¥åˆ†æ•°</b>ã€‚<br />
            2. <b>å®¡æ ¸é€šè¿‡åï¼Œä½ å°†ç«‹å³è§£é”å®Œæ•´çš„å¤§ç›˜æ•°æ®ã€æ’è¡Œä¸å›¾è¡¨ï¼</b><br />
            3. è¯·è€å¿ƒç­‰å¾…ï¼Œç¨åå¯é‡æ–°è¾“å…¥ QQ ç™»å½•æŸ¥çœ‹è¿›åº¦ã€‚
          </div>
          <button
            onclick="goToModify()"
            style="background-color: #3498db; margin-top: 25px"
          >
            æˆ‘æƒ³ä¿®æ”¹æäº¤çš„æ•°æ®
          </button>
          <button
            onclick="logout()"
            style="background-color: #7f8c8d; margin-top: 10px"
          >
            é€€å‡ºï¼Œç¨åå†æ¥çœ‹
          </button>
        </div>
      </div>

      <!-- é‡å¤çš„step5å·²åˆ é™¤ -->
      </div>
    </div>

    <script>
      // åç«¯APIåœ°å€
      const API_BASE_URL = "/api/score";

      // é€šç”¨APIè¯·æ±‚å‡½æ•°
      async function apiRequest(endpoint, method = "GET", data = null) {
        const url = `${API_BASE_URL}${endpoint}`;
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "omit",
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error("APIè¯·æ±‚é”™è¯¯:", error);
          throw error;
        }
      }

      // å›¾ç‰‡ä¸Šä¼ å‡½æ•°
      let uploadedPicturePath = "";
      async function uploadImage() {
        const scoreImageInput = document.getElementById("scoreImage");
        const uploadStatus = document.getElementById("uploadStatus");

        if (scoreImageInput.files.length > 0) {
          const file = scoreImageInput.files[0];
          const formData = new FormData();
          formData.append("file", file);

          uploadStatus.style.display = "block";
          uploadStatus.style.color = "#3498db";
          uploadStatus.textContent = "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...";

          try {
            const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
              method: "POST",
              body: formData,
            });

            const uploadResult = await uploadResponse.json();
            if (uploadResult.success) {
              uploadedPicturePath = uploadResult.data;
              uploadStatus.style.color = "#27ae60";
              uploadStatus.textContent = "å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼";
            } else {
              uploadStatus.style.color = "#e74c3c";
              uploadStatus.textContent = "å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©";
              uploadedPicturePath = "";
            }
          } catch (error) {
            console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥:", error);
            uploadStatus.style.color = "#e74c3c";
            uploadStatus.textContent = "ç½‘ç»œé”™è¯¯ï¼Œå›¾ç‰‡ä¸Šä¼ å¤±è´¥";
            uploadedPicturePath = "";
          }
        }
      }

      // åŠ¨æ€æ³¨å…¥ã€å¤§ç›˜èšåˆã€‘é€‰é¡¹
      const baseOptions = document.getElementById("majorSelect").innerHTML;
      const aggOptions = `
        <option disabled class="group-divider">====== ğŸ“Š å¤§ç›˜ç»¼åˆç»Ÿè®¡ ======</option>
        <option value="ALL_11408">ã€å¤§ç›˜ã€‘å…¨éƒ¨ 11408 è€ƒç”Ÿ (å­¦ç¡•)</option>
        <option value="ALL_22408">ã€å¤§ç›˜ã€‘å…¨éƒ¨ 22408 è€ƒç”Ÿ (ä¸“ç¡•)</option>
        <option value="ALL_085404">ã€èšåˆã€‘æ‰€æœ‰ è®¡ç®—æœºæŠ€æœ¯ (085404)</option>
        <option value="ALL_085405">ã€èšåˆã€‘æ‰€æœ‰ è½¯ä»¶å·¥ç¨‹ (085405)</option>
        <option value="ALL_085410">ã€èšåˆã€‘æ‰€æœ‰ äººå·¥æ™ºèƒ½ (085410)</option>
      `;
      document.getElementById("rankFilter").innerHTML =
        aggOptions + baseOptions;
      document.getElementById("chartMajorSelect").innerHTML =
        aggOptions + baseOptions;

      // é»˜è®¤é€‰ä¸­ 22408 å¤§ç›˜
      document.getElementById("rankFilter").value = "ALL_22408";

      // å…¨å±€å˜é‡ç®¡ç†
      let globalUserQQ = "";
      let globalRecordId = "";
      let globalIsApproved = false;

      // IndexedDB æœ¬åœ°å…œåº•ç¼“å­˜
      let db;
      const DB_NAME = "OUC2026ScoreDB_v3";
      const DB_VERSION = 1;
      const STORE_NAME = "scoreRecords";

      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onerror = (event) => reject(event.target.error);
          request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
          };
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const store = db.createObjectStore(STORE_NAME, { keyPath: "qq" });
              store.createIndex("major", "major", { unique: false });
              store.createIndex("total", "total", { unique: false });
            }
          };
        });
      }

      function saveRecord(record) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.put(record);
          request.onsuccess = () => resolve();
          request.onerror = (event) => reject(event.target.error);
        });
      }

      function getRecordByQQ(qq) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get(qq);
          request.onsuccess = (event) => resolve(event.target.result);
          request.onerror = (event) => reject(event.target.error);
        });
      }

      function getAllApprovedLocalRecords() {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();
          request.onsuccess = (event) => {
            let records = event.target.result || [];
            resolve(records.filter((r) => r.isApproved === true));
          };
          request.onerror = (event) => reject(event.target.error);
        });
      }

      initDB().catch((err) => console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", err));

      function showStep(stepNumber) {
        document
          .querySelectorAll(".step-box")
          .forEach((el) => el.classList.remove("active-step"));
        document
          .getElementById("step" + stepNumber)
          .classList.add("active-step");
      }

      function compressImageToBase64(file, callback) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const MAX_WIDTH = 600;
            let width = img.width;
            let height = img.height;
            if (width > MAX_WIDTH) {
              height = Math.round((height * MAX_WIDTH) / width);
              width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL("image/jpeg", 0.6));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      async function loginWithQQ() {
        let qq = document.getElementById("loginQQ").value.trim();
        if (!qq || qq.length < 5) {
          alert("è¯·è¾“å…¥æ­£ç¡®çš„QQå·ï¼");
          return;
        }

        let btn = document.getElementById("loginBtn");
        btn.innerText = "æ­£åœ¨æ ¸å¯¹æ¡£æ¡ˆ...";
        btn.disabled = true;

        try {
          const res = await apiRequest("/login", "POST", { qq });
          globalUserQQ = qq;
          document.getElementById("displayQQ").innerText = qq;

          if (res.success && res.data) {
            let myData = res.data;
            globalRecordId = myData.qq;
            globalIsApproved = myData.isDeleted === 0;

            // å¤„ç†å‡†è€ƒè¯å·ï¼ŒåŒæ—¶æ”¯æŒexamNumberå’Œexam_numberå­—æ®µ
            const examNumber = myData.examNumber || myData.exam_number || "";
            document.getElementById("ticketNum").value = examNumber;
            document.getElementById("majorSelect").value = myData.major;
            document.getElementById("sub1").value = myData.politics;
            document.getElementById("sub2").value = myData.english;
            document.getElementById("sub3").value = myData.math;
            document.getElementById("sub4").value = myData.professional;
            document.getElementById("imgRequireTip").innerText =
              "(å·²ä¸Šä¼ è¿‡ï¼Œå¦‚ä¸æ›´æ¢å¯ä¸é€‰)";

            // å¤„ç†å›¾ç‰‡è·¯å¾„
            if (myData.picture) {
              uploadedPicturePath = myData.picture;
              // åˆ›å»ºé¢„è§ˆå›¾ç‰‡
              const scoreImageInput = document.getElementById("scoreImage");
              const uploadStatus = document.getElementById("uploadStatus");
              if (uploadStatus) {
                uploadStatus.style.display = "block";
                uploadStatus.style.color = "#27ae60";
                uploadStatus.textContent = "å›¾ç‰‡å·²ä¸Šä¼ ";
              }
            }

            const record = {
              qq: qq,
              ticketNum: examNumber,
              major: myData.major,
              s1: myData.politics,
              s2: myData.english,
              s3: myData.math,
              s4: myData.professional,
              total: myData.total,
              isApproved: globalIsApproved,
            };
            saveRecord(record).catch((err) =>
              console.error("æœ¬åœ°ä¿å­˜å¤±è´¥:", err),
            );

            if (globalIsApproved) {
              showStep(3);
              fetchRanking();
            } else {
              showStep(5);
            }
          } else {
            getRecordByQQ(qq)
              .then((localData) => {
                if (localData) {
                  document.getElementById("ticketNum").value =
                    localData.ticketNum || "";
                  document.getElementById("majorSelect").value =
                    localData.major;
                  document.getElementById("sub1").value = localData.s1;
                  document.getElementById("sub2").value = localData.s2;
                  document.getElementById("sub3").value = localData.s3;
                  document.getElementById("sub4").value = localData.s4;
                  globalIsApproved = localData.isApproved === true;

                  if (globalIsApproved) {
                    showStep(3);
                    fetchRanking();
                  } else {
                    showStep(5);
                  }
                } else {
                  globalRecordId = "";
                  globalIsApproved = false;
                  document.getElementById("ticketNum").value = "";
                  document.getElementById("majorSelect").value = "";
                  document.getElementById("sub1").value = "";
                  document.getElementById("sub2").value = "";
                  document.getElementById("sub3").value = "";
                  document.getElementById("sub4").value = "";
                  document.getElementById("scoreImage").value = "";
                  document.getElementById("imgRequireTip").innerText =
                    "(æ–°å½•å…¥å¿…é¡»ä¸Šä¼ æˆªå›¾å‡­è¯)";
                  showStep(2);
                }
              })
              .catch(() => {
                showStep(2);
              });
          }
        } catch (err) {
          getRecordByQQ(qq)
            .then((localData) => {
              if (localData) {
                globalUserQQ = qq;
                document.getElementById("displayQQ").innerText = qq;
                document.getElementById("ticketNum").value =
                  localData.ticketNum || "";
                document.getElementById("majorSelect").value = localData.major;
                document.getElementById("sub1").value = localData.s1;
                document.getElementById("sub2").value = localData.s2;
                document.getElementById("sub3").value = localData.s3;
                document.getElementById("sub4").value = localData.s4;
                globalIsApproved = localData.isApproved === true;

                if (globalIsApproved) {
                  showStep(3);
                  fetchRanking();
                } else {
                  showStep(5);
                }
              } else {
                alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
              }
            })
            .catch(() => alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼"));
        } finally {
          btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
          btn.disabled = false;
        }
      }

      function goToModify() {
        document.getElementById("submitBtn").innerText =
          "ç¡®è®¤ä¿®æ”¹æ•°æ® (å°†é‡æ–°è¿›å…¥å®¡æ ¸)";
        document.getElementById("submitBtn").disabled = false;
        showStep(2);
      }

      async function submitCloudScore() {
        let ticketNum = document.getElementById("ticketNum").value;
        let major = document.getElementById("majorSelect").value;
        let v1 = document.getElementById("sub1").value;
        let v2 = document.getElementById("sub2").value;
        let v3 = document.getElementById("sub3").value;
        let v4 = document.getElementById("sub4").value;
        let scoreImageInput = document.getElementById("scoreImage");

        if (!ticketNum || ticketNum.length < 5) {
          alert("è¯·å¡«å†™æ­£ç¡®çš„å‡†è€ƒè¯å·ï¼");
          return;
        }
        if (!major) {
          alert("è¯·é€‰æ‹©æŠ¥è€ƒæ–¹å‘ï¼");
          return;
        }
        if (v1 === "" || v2 === "" || v3 === "" || v4 === "") {
          alert("æ¯ä¸€ç§‘æˆç»©éƒ½å¿…é¡»å¡«å†™å“¦ï¼");
          return;
        }
        if (!globalRecordId && scoreImageInput.files.length === 0) {
          alert("é¦–æ¬¡æäº¤å¿…é¡»ä¸Šä¼ æŸ¥åˆ†æˆªå›¾ï¼");
          return;
        }

        let s1 = Number(v1);
        let s2 = Number(v2);
        let s3 = Number(v3);
        let s4 = Number(v4);
        let total = s1 + s2 + s3 + s4;

        let btn = document.getElementById("submitBtn");
        btn.innerText = "æ•°æ®ä¼ è¾“ä¸­...";
        btn.disabled = true;

        try {
          // ä½¿ç”¨å·²ç»ä¸Šä¼ å¥½çš„å›¾ç‰‡è·¯å¾„
          const scoreData = {
            qq: globalUserQQ,
            major: major,
            politics: s1,
            english: s2,
            math: s3,
            professional: s4,
            total: total,
            isDeleted: 1, // é»˜è®¤æœªå¯ç”¨ï¼Œéœ€è¦å®¡æ ¸
            exam_number: ticketNum,
            picture: uploadedPicturePath
          };

          const res = await apiRequest("/submit", "POST", scoreData);
          
          if (res.success) {
            saveRecord({
              qq: globalUserQQ,
              ticketNum: ticketNum,
              major: major,
              s1: s1,
              s2: s2,
              s3: s3,
              s4: s4,
              total: total,
              isApproved: false,
            }).catch((err) => console.error("æœ¬åœ°ä¿å­˜å¤±è´¥:", err));

            if (!globalRecordId) {
              globalRecordId = globalUserQQ;
              alert("åˆè¯•æˆç»©ä¸å‡­è¯ä¸Šä¼ æˆåŠŸï¼");
            } else {
              alert("æˆç»©å·²æˆåŠŸæ›´æ–°ï¼Œéœ€é‡æ–°å®¡æ ¸ï¼");
            }
            showStep(5);
          } else {
            throw new Error("æäº¤å¤±è´¥");
          }
        } catch (err) {
          console.error("æäº¤å¤±è´¥:", err);
          alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ•°æ®å·²æš‚å­˜æœ¬åœ°ï¼Œå¾…ç½‘ç»œæ¢å¤åè¯·é‡æ–°ç‚¹å‡»æäº¤ï¼");
        } finally {
          btn.innerText = globalRecordId
            ? "ç¡®è®¤ä¿®æ”¹æ•°æ® (å°†é‡æ–°è¿›å…¥å®¡æ ¸)"
            : "æäº¤æ•°æ®ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸";
          btn.disabled = false;
        }
      }

      // ã€æ ¸å¿ƒèšåˆé€»è¾‘ã€‘
      async function getAggregatedData(selectedMajor) {
        let records = [];
        try {
          // ç”±äºåç«¯APIä¸æ”¯æŒèšåˆæŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦è·å–æ‰€æœ‰æ•°æ®ååœ¨å‰ç«¯è¿›è¡Œè¿‡æ»¤
          // è¿™é‡Œä½¿ç”¨ä¸“ä¸šè¯¾æ–¹å‘ä½œä¸ºæŸ¥è¯¢å‚æ•°ï¼Œåç»­åœ¨å‰ç«¯è¿›è¡Œèšåˆ
          const major = selectedMajor.includes("ALL_")
            ? "081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†)"
            : selectedMajor;
          const res = await apiRequest(
            `/ranking?major=${encodeURIComponent(major)}`,
          );
          if (res.success && res.data) {
            records = res.data.map((item) => ({
              qq: item.qq,
              major: item.major,
              s1: item.politics,
              s2: item.english,
              s3: item.math,
              s4: item.professional,
              total: item.total,
            }));
          }
        } catch (e) {
          console.warn("äº‘ç«¯æ‹‰å–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜");
          records = await getAllApprovedLocalRecords();
        }

        if (selectedMajor === "ALL_11408") {
          return records.filter(
            (r) =>
              r.major &&
              (r.major.includes("081200") || r.major.includes("0812Z1")),
          );
        } else if (selectedMajor === "ALL_22408") {
          return records.filter((r) => r.major && r.major.includes("0854"));
        } else if (selectedMajor === "ALL_085404") {
          return records.filter((r) => r.major && r.major.includes("085404"));
        } else if (selectedMajor === "ALL_085405") {
          return records.filter((r) => r.major && r.major.includes("085405"));
        } else if (selectedMajor === "ALL_085410") {
          return records.filter((r) => r.major && r.major.includes("085410"));
        } else {
          return records.filter((r) => r.major === selectedMajor);
        }
      }

      function renderStatsBanner(records) {
        const statsDiv = document.getElementById("statsBanner");
        if (records.length === 0) {
          statsDiv.innerHTML = "";
          return;
        }
        let max = Math.max(...records.map((r) => r.total));
        let min = Math.min(...records.map((r) => r.total));
        let sum = records.reduce((acc, r) => acc + r.total, 0);
        let avg = (sum / records.length).toFixed(1);

        statsDiv.innerHTML = `
              <div class="stats-banner">
                  <span>ğŸ‘¥ å·²æ ¸äººæ•°: ${records.length}</span>
                  <span>ğŸ”¥ æœ€é«˜åˆ†: ${max}</span>
                  <span>â„ï¸ æœ€ä½åˆ†: ${min}</span>
                  <span>ğŸ“ˆ å¹³å‡åˆ†: ${avg}</span>
              </div>
          `;
      }

      async function fetchRanking() {
        let selectedMajor = document.getElementById("rankFilter").value;
        let rankDiv = document.getElementById("rankingList");
        rankDiv.innerHTML = "æ­£åœ¨æ‹‰å–å®¡æ ¸æ•°æ®...";
        document.getElementById("statsBanner").innerHTML = "";

        try {
          let records = await getAggregatedData(selectedMajor);
          records.sort((a, b) => b.total - a.total);

          renderStatsBanner(records);
          displayRanking(records, rankDiv, selectedMajor);
        } catch (e) {
          rankDiv.innerHTML = "æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
        }
      }

      function displayRanking(records, rankDiv, selectedMajor) {
        let htmlStr = "";
        if (records.length === 0) {
          rankDiv.innerHTML = `<div style="text-align:center; color:#999; margin-top:20px;">è¯¥èŒƒå›´æš‚æ— å·²å®¡æ ¸é€šè¿‡çš„æˆç»©æ•°æ®ã€‚</div>`;
          return;
        }
        records.forEach((item, index) => {
          let qq = item.qq;
          let isMe = qq === globalUserQQ;
          let bgStyle = isMe
            ? "background: #fff3cd; border-left: 5px solid #f39c12;"
            : "";
          let meTag = isMe
            ? `<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">æˆ‘</span>`
            : "";

          // å¤§ç›˜æ¨¡å¼ä¸‹ï¼Œé¢å¤–æ˜¾ç¤ºä»–ä»¬çš„å…·ä½“ä¸“ä¸šæ–¹å‘
          let majorInfo = selectedMajor.startsWith("ALL_")
            ? `<div style="font-size:11px; color:#0056b3; margin-top:3px; word-break: break-all;">${item.major}</div>`
            : "";

          htmlStr += `
                <div class="rank-item" style="${bgStyle}">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="rank-detail">
                        <strong>æ€»åˆ†ï¼š<span style="color:#e74c3c; font-size:16px;">${item.total}</span></strong> ${meTag}<br>
                        <span style="font-size:12px; color:#555;">æ”¿:${item.s1} | è‹±:${item.s2} | æ•°:${item.s3} | 408:${item.s4}</span>
                        ${majorInfo}
                    </div>
                </div>
            `;
        });
        rankDiv.innerHTML = htmlStr;
      }

      function logout() {
        globalUserQQ = "";
        globalRecordId = "";
        globalIsApproved = false;
        document.getElementById("loginQQ").value = "";
        showStep(1);
      }

      function showCharts() {
        document.getElementById("chartMajorSelect").value =
          document.getElementById("rankFilter").value;
        showStep(4);
        updateChart();
      }

      let chartInstance;

      async function updateChart() {
        const selectedMajor = document.getElementById("chartMajorSelect").value;
        const selectedSubject =
          document.getElementById("chartSubjectSelect").value;
        const chartContainer = document.getElementById("chartContainer");
        const subjectNames = {
          total: "æ€»åˆ†",
          s1: "æ”¿æ²»",
          s2: "è‹±è¯­",
          s3: "æ•°å­¦",
          s4: "ä¸“ä¸šè¯¾(408)",
        };

        if (!chartInstance) {
          chartInstance = echarts.init(chartContainer);
        }

        try {
          let records = await getAggregatedData(selectedMajor);
          records.sort((a, b) => b[selectedSubject] - a[selectedSubject]);

          const ranks = records.map((_, index) => index + 1).reverse();
          const scores = records.map((r) => r[selectedSubject]).reverse();
          const names = records.map((r) => `#${r.qq.toString().slice(-4)}`).reverse();

          const selectEl = document.getElementById("chartMajorSelect");
          const titlePrefix = selectEl.options[selectEl.selectedIndex].text
            .replace("ã€å¤§ç›˜ã€‘", "")
            .replace("ã€èšåˆã€‘", "");

          const option = {
            title: {
              text:
                titlePrefix + subjectNames[selectedSubject] + "åˆ†å¸ƒ",
              left: "center",
              textStyle: { fontSize: 14 },
            },
            tooltip: {
              trigger: "axis",
              formatter: function (params) {
                const index = params[0].dataIndex;
                return `æ’å: ${ranks[index]}<br/>${subjectNames[selectedSubject]}: ${scores[index]}<br/>å°¾å·: ${names[index]}<br/><span style="font-size:10px;">${records[records.length - 1 - index].major}</span>`;
              },
            },
            xAxis: {
              type: "category",
              data: ranks,
              name: "æ’å",
              nameLocation: "middle",
              nameGap: 30,
            },
            yAxis: {
              type: "value",
              name: subjectNames[selectedSubject],
              nameLocation: "middle",
              nameGap: 50,
            },
            series: [
              {
                data: scores,
                type: "line",
                smooth: true,
                symbol: "circle",
                symbolSize: 6,
                lineStyle: { width: 3 },
                itemStyle: { color: "#0056b3" },
                areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: "rgba(0, 86, 179, 0.3)" },
                    { offset: 1, color: "rgba(0, 86, 179, 0.1)" },
                  ]),
                },
              },
            ],
          };
          chartInstance.setOption(option);
        } catch (err) {
          console.error("è·å–å›¾è¡¨æ•°æ®å¤±è´¥:", err);
          chartInstance.setOption({
            title: { text: "è·å–æ•°æ®å¤±è´¥æˆ–æš‚æ— æ•°æ®", left: "center" },
            series: [],
          });
        }
      }

      window.addEventListener("resize", function () {
        if (chartInstance) {
          chartInstance.resize();
        }
      });
    </script>
  </body>
</html>
