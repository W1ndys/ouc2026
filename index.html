<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨åˆè¯•å½•åˆ†ä¸æ’å</title>
    <script src="https://cdn.jsdelivr.net/npm/hydrogen-js-sdk/dist/Bmob-2.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f4f7f6;
        display: flex;
        justify-content: center;
        padding: 20px 10px;
        margin: 0;
      }
      .container {
        background-color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        width: 95%;
        box-sizing: border-box;
      }
      h2 {
        text-align: center;
        color: #0056b3;
        font-size: 20px;
        line-height: 1.4;
        margin-bottom: 5px;
      }
      .notice {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        font-size: 12px;
        color: #856404;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .step-box {
        display: none;
      }
      .active-step {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #444;
        font-weight: bold;
        font-size: 14px;
      }
      .sub-label {
        font-size: 12px;
        color: #888;
        font-weight: normal;
        margin-left: 5px;
      }
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
      }
      button {
        width: 100%;
        padding: 12px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #004494;
      }
      button:disabled {
        background-color: #999 !important;
        cursor: not-allowed;
      }

      .rank-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 5px solid #0056b3;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .rank-num {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
        width: 40px;
      }
      .rank-detail {
        flex-grow: 1;
      }

      /* ç™»å½•é¡µä¸“å±æ ·å¼ */
      .login-box {
        text-align: center;
        padding: 20px 0;
      }
      .login-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨<br />åˆè¯•æˆç»©å½•å…¥ä¸æ’å</h2>

      <div class="notice">
        <strong>âš ï¸ é˜²åˆ·æ¦œæ ¸å®å£°æ˜ï¼š</strong><br />
        ä¸ºä¿è¯æ¦œå•çº¯æ´æ€§ï¼Œç³»ç»Ÿå·²å¼€å¯æš—è®¿æœºåˆ¶ã€‚ç®¡ç†å‘˜å°†é€šè¿‡é¢„ç•™çš„QQå·æ·»åŠ æ ¸éªŒã€å‡†è€ƒè¯ã€‘ä¸ã€æˆç»©æˆªå›¾ã€‘ã€‚æ— æ³•æä¾›è€…ï¼Œæˆç»©å°†è¢«ç›´æ¥å‰”é™¤ã€‚
      </div>

      <div id="step1" class="step-box active-step">
        <div class="login-box">
          <div class="login-icon">ğŸ§</div>
          <h3 style="color: #333; margin-bottom: 20px">èº«ä»½é€šè¡Œè¯</h3>
          <div class="input-group" style="text-align: left">
            <label>è¯·è¾“å…¥ä½ çš„çœŸå® QQ å·</label>
            <input
              type="number"
              id="loginQQ"
              placeholder="è¾“å…¥QQå·è¿›å…¥ç³»ç»Ÿ / æ‰¾å›æˆç»©"
            />
          </div>
          <button id="loginBtn" onclick="loginWithQQ()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
      </div>

      <div id="step2" class="step-box">
        <div
          style="
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #0056b3;
            text-align: center;
          "
        >
          å½“å‰ç™»å½•èº«ä»½ï¼šQQ <strong id="displayQQ"></strong>
        </div>

        <div class="input-group">
          <label>æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘</label>
          <select id="majorSelect">
            <option value="" disabled selected>è¯·é€‰æ‹©ä½ çš„ä¸“ä¸šä¸æ–¹å‘...</option>
            <optgroup label="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
              <option value="081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†)">
                081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯†">
              <option value="0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†)">
                0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="è®¡ç®—æœºæŠ€æœ¯">
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="è½¯ä»¶å·¥ç¨‹">
              <option value="085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†)">
                085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="äººå·¥æ™ºèƒ½">
              <option value="085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)">
                085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)
              </option>
              <option value="085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)">
                085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)
              </option>
              <option value="085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†)">
                085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹">
              <option value="085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†)">
                085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨">
              <option value="085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†)">
                085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
          </select>
        </div>

        <div class="input-group">
          <label>æ”¿æ²»</label
          ><input type="number" id="sub1" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>è‹±è¯­</label
          ><input type="number" id="sub2" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>æ•°å­¦</label
          ><input type="number" id="sub3" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>ä¸“ä¸šè¯¾(408)</label
          ><input type="number" id="sub4" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>

        <button id="submitBtn" onclick="submitCloudScore()">æäº¤æˆç»©</button>
      </div>

      <div id="step3" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          å®æ—¶æ€»åˆ†æ’è¡Œæ¦œ
        </h3>

        <div
          class="input-group"
          style="background: #e9f2fb; padding: 10px; border-radius: 6px"
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >å½“å‰æ¦œå•ä¸“ä¸šæ–¹å‘ï¼š</label
          >
          <select
            id="rankFilter"
            onchange="fetchRanking()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div id="rankingList" style="margin-top: 15px; font-size: 14px">
          æ­£åœ¨åŠªåŠ›ä»äº‘ç«¯æ‹‰å–æ’åæ•°æ®...
        </div>

        <button
          id="modifyBtn"
          onclick="goToModify()"
          style="background-color: #e67e22; margin-top: 20px"
        >
          å‘ç°å¡«é”™ï¼Ÿè¿”å›ä¿®æ”¹æˆç»©
        </button>
        <button
          onclick="showCharts()"
          style="background-color: #27ae60; margin-top: 10px"
        >
          æŸ¥çœ‹æˆç»©è¶‹åŠ¿å›¾è¡¨
        </button>
        <button
          onclick="logout()"
          style="background-color: #7f8c8d; margin-top: 10px"
        >
          å®‰å…¨é€€å‡ºå½“å‰ QQ
        </button>
      </div>

      <div id="step4" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          æˆç»©è¶‹åŠ¿å›¾è¡¨
        </h3>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ä¸“ä¸šæ–¹å‘ï¼š</label
          >
          <select
            id="chartMajorSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ç§‘ç›®ï¼š</label
          >
          <select
            id="chartSubjectSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          >
            <option value="total">æ€»åˆ†</option>
            <option value="s1">æ”¿æ²»</option>
            <option value="s2">è‹±è¯­</option>
            <option value="s3">æ•°å­¦</option>
            <option value="s4">ä¸“ä¸šè¯¾(408)</option>
          </select>
        </div>

        <div
          id="chartContainer"
          style="width: 100%; height: 400px; margin-top: 20px; min-width: 300px"
        ></div>

        <button
          onclick="showStep(3)"
          style="background-color: #7f8c8d; margin-top: 20px"
        >
          è¿”å›æ’åé¡µé¢
        </button>
      </div>
    </div>

    <script>
      // Bmob å¯†é’¥åˆå§‹åŒ–
      Bmob.initialize("3214f8afece0391a", "ouc2026score1234");
      document.getElementById("rankFilter").innerHTML =
        document.getElementById("majorSelect").innerHTML;

      // å…¨å±€å˜é‡ç®¡ç†ç”¨æˆ·çŠ¶æ€ï¼ˆçº¯å†…å­˜ï¼Œåˆ·æ–°å³ä¸¢ï¼Œç»å¯¹ä¸ç¼“å­˜åˆ°ç¡¬ç›˜ï¼‰
      let globalUserQQ = "";
      let globalRecordId = "";

      // SQLite æ•°æ®åº“æ“ä½œ
      let db;
      const DB_NAME = "OUC2026ScoreDB";
      const DB_VERSION = 1;
      const STORE_NAME = "scoreRecords";

      // åˆå§‹åŒ–æ•°æ®åº“
      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = (event) => {
            console.error("æ•°æ®åº“æ‰“å¼€å¤±è´¥:", event.target.error);
            reject(event.target.error);
          };

          request.onsuccess = (event) => {
            db = event.target.result;
            console.log("æ•°æ®åº“æ‰“å¼€æˆåŠŸ");
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const store = db.createObjectStore(STORE_NAME, { keyPath: "qq" });
              store.createIndex("major", "major", { unique: false });
              store.createIndex("total", "total", { unique: false });
            }
          };
        });
      }

      // ä¿å­˜æˆ–æ›´æ–°è®°å½•
      function saveRecord(record) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.put(record);

          request.onsuccess = () => {
            console.log("è®°å½•ä¿å­˜æˆåŠŸ");
            resolve();
          };

          request.onerror = (event) => {
            console.error("è®°å½•ä¿å­˜å¤±è´¥:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // æ ¹æ®QQå·è·å–è®°å½•
      function getRecordByQQ(qq) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get(qq);

          request.onsuccess = (event) => {
            resolve(event.target.result);
          };

          request.onerror = (event) => {
            console.error("è·å–è®°å½•å¤±è´¥:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // æ ¹æ®ä¸“ä¸šè·å–æ’å
      function getRankingByMajor(major) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const index = store.index("major");
          const request = index.getAll(IDBKeyRange.only(major));

          request.onsuccess = (event) => {
            const records = event.target.result;
            // æŒ‰æ€»åˆ†æ’åº
            records.sort((a, b) => b.total - a.total);
            resolve(records);
          };

          request.onerror = (event) => {
            console.error("è·å–æ’åå¤±è´¥:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // åˆ é™¤è®°å½•
      function deleteRecord(qq) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.delete(qq);

          request.onsuccess = () => {
            console.log("è®°å½•åˆ é™¤æˆåŠŸ");
            resolve();
          };

          request.onerror = (event) => {
            console.error("è®°å½•åˆ é™¤å¤±è´¥:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // åˆå§‹åŒ–æ•°æ®åº“
      initDB().catch((err) => console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", err));

      function showStep(stepNumber) {
        document
          .querySelectorAll(".step-box")
          .forEach((el) => el.classList.remove("active-step"));
        document
          .getElementById("step" + stepNumber)
          .classList.add("active-step");
      }

      // ç™»å½•æ ¸å¿ƒé€»è¾‘ï¼šåŒæ—¶ä»äº‘ç«¯å’Œæœ¬åœ°è·å–æ•°æ®
      function loginWithQQ() {
        let qq = document.getElementById("loginQQ").value;
        if (!qq || qq.length < 5) {
          alert("è¯·è¾“å…¥æ­£ç¡®çš„QQå·ï¼");
          return;
        }

        let btn = document.getElementById("loginBtn");
        btn.innerText = "æ­£åœ¨æ ¸å¯¹æ¡£æ¡ˆ...";
        btn.disabled = true;

        // å…ˆä»äº‘ç«¯è·å–æ•°æ®
        const query = Bmob.Query("ScoreRecord");
        query.equalTo("qq", "==", qq);
        query
          .find()
          .then((res) => {
            globalUserQQ = qq;
            document.getElementById("displayQQ").innerText = qq;

            // åªè¦äº‘ç«¯æŸ¥åˆ°æ•°æ®ï¼Œå°±æ˜¯è€ç”¨æˆ·
            if (res.length > 0) {
              let myData = res[0];
              globalRecordId = myData.objectId;

              document.getElementById("majorSelect").value = myData.major;
              document.getElementById("sub1").value = myData.s1;
              document.getElementById("sub2").value = myData.s2;
              document.getElementById("sub3").value = myData.s3;
              document.getElementById("sub4").value = myData.s4;

              // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
              const record = {
                qq: qq,
                major: myData.major,
                s1: myData.s1,
                s2: myData.s2,
                s3: myData.s3,
                s4: myData.s4,
                total: myData.total,
              };
              saveRecord(record).catch((err) =>
                console.error("æœ¬åœ°ä¿å­˜å¤±è´¥:", err),
              );

              document.getElementById("rankFilter").value = myData.major;
              showStep(3);
              fetchRanking();
            }
            // äº‘ç«¯æ²¡æŸ¥åˆ°ï¼Œå°è¯•ä»æœ¬åœ°æ•°æ®åº“è·å–
            else {
              getRecordByQQ(qq)
                .then((localData) => {
                  if (localData) {
                    // æœ¬åœ°æœ‰æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                    document.getElementById("majorSelect").value =
                      localData.major;
                    document.getElementById("sub1").value = localData.s1;
                    document.getElementById("sub2").value = localData.s2;
                    document.getElementById("sub3").value = localData.s3;
                    document.getElementById("sub4").value = localData.s4;

                    document.getElementById("rankFilter").value =
                      localData.major;
                    showStep(3);
                    fetchRanking();
                  } else {
                    // æœ¬åœ°ä¹Ÿæ²¡æœ‰æ•°æ®ï¼ŒæŒ‰æ–°ç”¨æˆ·å¤„ç†
                    globalRecordId = "";
                    // æ¸…ç©ºè¡¨æ ¼ï¼Œé˜²æ­¢ä¸Šä¸€ä¸ªäººçš„ç—•è¿¹ä¸²åœº
                    document.getElementById("majorSelect").value = "";
                    document.getElementById("sub1").value = "";
                    document.getElementById("sub2").value = "";
                    document.getElementById("sub3").value = "";
                    document.getElementById("sub4").value = "";

                    showStep(2);
                  }
                })
                .catch((err) => {
                  console.error("æœ¬åœ°æŸ¥è¯¢å¤±è´¥:", err);
                  // æœ¬åœ°æŸ¥è¯¢å¤±è´¥ï¼ŒæŒ‰æ–°ç”¨æˆ·å¤„ç†
                  globalRecordId = "";
                  document.getElementById("majorSelect").value = "";
                  document.getElementById("sub1").value = "";
                  document.getElementById("sub2").value = "";
                  document.getElementById("sub3").value = "";
                  document.getElementById("sub4").value = "";

                  showStep(2);
                });
            }

            btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
            btn.disabled = false;
          })
          .catch((err) => {
            console.error("äº‘ç«¯æŸ¥è¯¢å¤±è´¥:", err);
            // äº‘ç«¯æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°æ•°æ®åº“è·å–
            getRecordByQQ(qq)
              .then((localData) => {
                if (localData) {
                  // æœ¬åœ°æœ‰æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                  globalUserQQ = qq;
                  document.getElementById("displayQQ").innerText = qq;
                  document.getElementById("majorSelect").value =
                    localData.major;
                  document.getElementById("sub1").value = localData.s1;
                  document.getElementById("sub2").value = localData.s2;
                  document.getElementById("sub3").value = localData.s3;
                  document.getElementById("sub4").value = localData.s4;

                  document.getElementById("rankFilter").value = localData.major;
                  showStep(3);
                  fetchRanking();
                } else {
                  // æœ¬åœ°ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œæç¤ºç½‘ç»œå¤±è´¥
                  alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
                }
              })
              .catch((localErr) => {
                console.error("æœ¬åœ°æŸ¥è¯¢ä¹Ÿå¤±è´¥:", localErr);
                alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
              })
              .finally(() => {
                btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
                btn.disabled = false;
              });
          });
      }

      function goToModify() {
        document.getElementById("submitBtn").innerText = "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤";
        document.getElementById("submitBtn").disabled = false;
        showStep(2);
      }

      function submitCloudScore() {
        let major = document.getElementById("majorSelect").value;
        let v1 = document.getElementById("sub1").value;
        let v2 = document.getElementById("sub2").value;
        let v3 = document.getElementById("sub3").value;
        let v4 = document.getElementById("sub4").value;

        if (!major) {
          alert("è¯·é€‰æ‹©æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘ï¼");
          return;
        }
        if (v1 === "" || v2 === "" || v3 === "" || v4 === "") {
          alert("æ¯ä¸€ç§‘æˆç»©éƒ½å¿…é¡»å¡«å†™å“¦ï¼");
          return;
        }

        let s1 = Number(v1);
        let s2 = Number(v2);
        let s3 = Number(v3);
        let s4 = Number(v4);
        let total = s1 + s2 + s3 + s4;

        let btn = document.getElementById("submitBtn");
        btn.innerText = "æ•°æ®ä¼ è¾“ä¸­...";
        btn.disabled = true;

        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
        const record = {
          qq: globalUserQQ,
          major: major,
          s1: s1,
          s2: s2,
          s3: s3,
          s4: s4,
          total: total,
        };
        saveRecord(record).catch((err) => console.error("æœ¬åœ°ä¿å­˜å¤±è´¥:", err));

        // ä¿å­˜åˆ°äº‘ç«¯
        const query = Bmob.Query("ScoreRecord");
        // å¦‚æœæœ‰äº‘ç«¯ IDï¼Œå°±æ‰§è¡Œæ›´æ–°ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±æ‰§è¡Œæ–°å»º
        if (globalRecordId) {
          query.set("id", globalRecordId);
        }
        query.set("qq", globalUserQQ);
        query.set("major", major);
        query.set("s1", s1);
        query.set("s2", s2);
        query.set("s3", s3);
        query.set("s4", s4);
        query.set("total", total);

        query
          .save()
          .then((res) => {
            if (!globalRecordId) {
              globalRecordId = res.objectId;
              alert("åˆè¯•æˆç»©å½•å…¥æˆåŠŸï¼");
            } else {
              alert("æˆç»©å·²æˆåŠŸæ›´æ–°ï¼");
            }

            document.getElementById("rankFilter").value = major;
            showStep(3);
            fetchRanking();
          })
          .catch((err) => {
            console.error("äº‘ç«¯ä¿å­˜å¤±è´¥:", err);
            // äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä½†æœ¬åœ°å·²ç»ä¿å­˜æˆåŠŸ
            alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæˆç»©å·²ä¿å­˜åˆ°æœ¬åœ°");
            document.getElementById("rankFilter").value = major;
            showStep(3);
            fetchRanking();
          })
          .finally(() => {
            btn.innerText = globalRecordId ? "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤" : "æäº¤æˆç»©";
            btn.disabled = false;
          });
      }

      function fetchRanking() {
        let selectedMajor = document.getElementById("rankFilter").value;
        let rankDiv = document.getElementById("rankingList");
        rankDiv.innerHTML = "æ­£åœ¨æ‹‰å– " + selectedMajor + " çš„æ’å...";

        // å…ˆä»äº‘ç«¯è·å–æ•°æ®
        const query = Bmob.Query("ScoreRecord");
        query.equalTo("major", "==", selectedMajor);
        query.order("-total");
        query.limit(100);

        query
          .find()
          .then((records) => {
            displayRanking(records, rankDiv, selectedMajor);
          })
          .catch((err) => {
            console.error("äº‘ç«¯æ’åè·å–å¤±è´¥:", err);
            // äº‘ç«¯è·å–å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°æ•°æ®åº“è·å–
            getRankingByMajor(selectedMajor)
              .then((localRecords) => {
                displayRanking(localRecords, rankDiv, selectedMajor);
              })
              .catch((localErr) => {
                console.error("æœ¬åœ°æ’åè·å–å¤±è´¥:", localErr);
                rankDiv.innerHTML = "æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
              });
          });
      }

      // æ˜¾ç¤ºæ’å
      function displayRanking(records, rankDiv, selectedMajor) {
        let htmlStr = "";
        if (records.length === 0) {
          rankDiv.innerHTML = `<div style="text-align:center; color:#999; margin-top:20px;">è¯¥æ–¹å‘ç›®å‰è¿˜æ²¡æœ‰äººå½•å…¥æˆç»©ï¼Œå¿«æ¥æŠ¢å æ²™å‘ï¼</div>`;
          return;
        }

        records.forEach((item, index) => {
          // åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰ç™»å½•çš„ QQ å·ï¼Œé«˜äº®æ˜¾ç¤ºè‡ªå·±çš„æˆç»©
          let isMe = item.qq === globalUserQQ;
          let bgStyle = isMe
            ? "background: #fff3cd; border-left: 5px solid #f39c12;"
            : "";
          let meTag = isMe
            ? `<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">æˆ‘</span>`
            : "";

          htmlStr += `
                <div class="rank-item" style="${bgStyle}">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="rank-detail">
                        <strong>æ€»åˆ†ï¼š<span style="color:#e74c3c; font-size:16px;">${item.total}</span></strong> ${meTag}<br>
                        <span style="font-size:12px; color:#555;">æ”¿:${item.s1} | è‹±:${item.s2} | æ•°:${item.s3} | 408:${item.s4}</span>
                    </div>
                </div>
            `;
        });
        rankDiv.innerHTML = htmlStr;
      }

      // é€€å‡ºæ¸…ç©ºå†…å­˜çŠ¶æ€ï¼Œå›å½’åˆå§‹
      function logout() {
        globalUserQQ = "";
        globalRecordId = "";
        document.getElementById("loginQQ").value = "";
        showStep(1);
      }

      // æ˜¾ç¤ºå›¾è¡¨é¡µé¢
      function showCharts() {
        // åˆå§‹åŒ–å›¾è¡¨ä¸“ä¸šé€‰æ‹©å™¨
        document.getElementById("chartMajorSelect").innerHTML =
          document.getElementById("majorSelect").innerHTML;
        // é»˜è®¤ä¸ºå½“å‰é€‰æ‹©çš„ä¸“ä¸š
        document.getElementById("chartMajorSelect").value =
          document.getElementById("rankFilter").value;
        // æ˜¾ç¤ºå›¾è¡¨é¡µé¢
        showStep(4);
        // æ›´æ–°å›¾è¡¨
        updateChart();
      }

      // å›¾è¡¨å®ä¾‹
      let chartInstance;

      // æ›´æ–°å›¾è¡¨
      function updateChart() {
        const selectedMajor = document.getElementById("chartMajorSelect").value;
        const selectedSubject =
          document.getElementById("chartSubjectSelect").value;
        const chartContainer = document.getElementById("chartContainer");

        // ç§‘ç›®åç§°æ˜ å°„
        const subjectNames = {
          total: "æ€»åˆ†",
          s1: "æ”¿æ²»",
          s2: "è‹±è¯­",
          s3: "æ•°å­¦",
          s4: "ä¸“ä¸šè¯¾(408)",
        };

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        if (!chartInstance) {
          chartInstance = echarts.init(chartContainer);
        }

        // ä»æœ¬åœ°æ•°æ®åº“è·å–æ•°æ®
        getRankingByMajor(selectedMajor)
          .then((records) => {
            // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»äº‘ç«¯è·å–
            if (records.length === 0) {
              const query = Bmob.Query("ScoreRecord");
              query.equalTo("major", "==", selectedMajor);
              query.order("-total");
              return query.find();
            }
            return records;
          })
          .then((records) => {
            // å¤„ç†æ•°æ®
            const sortedRecords = records.sort(
              (a, b) => a[selectedSubject] - b[selectedSubject],
            );
            const ranks = sortedRecords.map((_, index) => index + 1);
            const scores = sortedRecords.map(
              (record) => record[selectedSubject],
            );
            const names = sortedRecords.map(
              (record) => `#${record.qq.slice(-4)}`,
            );

            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
              title: {
                text:
                  selectedMajor +
                  " " +
                  subjectNames[selectedSubject] +
                  "æˆç»©è¶‹åŠ¿",
                left: "center",
              },
              tooltip: {
                trigger: "axis",
                formatter: function (params) {
                  const index = params[0].dataIndex;
                  return `æ’å: ${ranks[index]}<br/>${subjectNames[selectedSubject]}: ${scores[index]}<br/>ç”¨æˆ·: ${names[index]}`;
                },
              },
              xAxis: {
                type: "category",
                data: ranks,
                name: "æ’å",
                nameLocation: "middle",
                nameGap: 30,
              },
              yAxis: {
                type: "value",
                name: subjectNames[selectedSubject],
                nameLocation: "middle",
                nameGap: 50,
              },
              series: [
                {
                  data: scores,
                  type: "line",
                  smooth: true,
                  symbol: "circle",
                  symbolSize: 8,
                  lineStyle: {
                    width: 3,
                  },
                  itemStyle: {
                    color: "#0056b3",
                  },
                  areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      {
                        offset: 0,
                        color: "rgba(0, 86, 179, 0.3)",
                      },
                      {
                        offset: 1,
                        color: "rgba(0, 86, 179, 0.1)",
                      },
                    ]),
                  },
                },
              ],
            };

            // è®¾ç½®å›¾è¡¨é€‰é¡¹
            chartInstance.setOption(option);
          })
          .catch((err) => {
            console.error("è·å–å›¾è¡¨æ•°æ®å¤±è´¥:", err);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            chartInstance.setOption({
              title: {
                text: "è·å–æ•°æ®å¤±è´¥",
                left: "center",
              },
              series: [],
            });
          });
      }

      // çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
      window.addEventListener("resize", function () {
        if (chartInstance) {
          chartInstance.resize();
        }
      });
    </script>
  </body>
</html>
