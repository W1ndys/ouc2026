<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨åˆè¯•å½•åˆ†ä¸æ’å</title>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f4f7f6;
        display: flex;
        justify-content: center;
        padding: 20px 10px;
        margin: 0;
      }
      .container {
        background-color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        width: 95%;
        box-sizing: border-box;
      }
      h2 {
        text-align: center;
        color: #0056b3;
        font-size: 20px;
        line-height: 1.4;
        margin-bottom: 5px;
      }
      .notice {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        font-size: 12px;
        color: #856404;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .step-box {
        display: none;
      }
      .active-step {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #444;
        font-weight: bold;
        font-size: 14px;
      }
      .sub-label {
        font-size: 12px;
        color: #888;
        font-weight: normal;
        margin-left: 5px;
      }
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
      }
      button {
        width: 100%;
        padding: 12px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 15px;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #004494;
      }
      button:disabled {
        background-color: #999 !important;
        cursor: not-allowed;
      }

      .rank-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 5px solid #0056b3;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .rank-num {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
        width: 40px;
      }
      .rank-detail {
        flex-grow: 1;
      }

      /* ç™»å½•é¡µä¸“å±æ ·å¼ */
      .login-box {
        text-align: center;
        padding: 20px 0;
      }
      .login-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ä¸­å›½æµ·æ´‹å¤§å­¦26ä¿¡æ¯å­¦éƒ¨<br />åˆè¯•æˆç»©å½•å…¥ä¸æ’å</h2>

      <div class="notice">
        <strong>âš ï¸ é˜²åˆ·æ¦œæ ¸å®å£°æ˜ï¼š</strong><br />
        ä¸ºä¿è¯æ¦œå•çº¯æ´æ€§ï¼Œç³»ç»Ÿå·²å¼€å¯æš—è®¿æœºåˆ¶ã€‚ç®¡ç†å‘˜å°†é€šè¿‡é¢„ç•™çš„QQå·æ·»åŠ æ ¸éªŒã€å‡†è€ƒè¯ã€‘ä¸ã€æˆç»©æˆªå›¾ã€‘ã€‚æ— æ³•æä¾›è€…ï¼Œæˆç»©å°†è¢«ç›´æ¥å‰”é™¤ã€‚
      </div>

      <div id="step1" class="step-box active-step">
        <div class="login-box">
          <div class="login-icon">ğŸ§</div>
          <h3 style="color: #333; margin-bottom: 20px">èº«ä»½é€šè¡Œè¯</h3>
          <div class="input-group" style="text-align: left">
            <label>è¯·è¾“å…¥ä½ çš„çœŸå® QQ å·</label>
            <input
              type="number"
              id="loginQQ"
              placeholder="è¾“å…¥QQå·è¿›å…¥ç³»ç»Ÿ / æ‰¾å›æˆç»©"
            />
          </div>
          <button id="loginBtn" onclick="loginWithQQ()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
      </div>

      <div id="step2" class="step-box">
        <div
          style="
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #0056b3;
            text-align: center;
          "
        >
          å½“å‰ç™»å½•èº«ä»½ï¼šQQ <strong id="displayQQ"></strong>
        </div>

        <div class="input-group">
          <label>æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘</label>
          <select id="majorSelect">
            <option value="" disabled selected>è¯·é€‰æ‹©ä½ çš„ä¸“ä¸šä¸æ–¹å‘...</option>
            <optgroup label="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯">
              <option value="081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†)">
                081200 è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯†">
              <option value="0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†)">
                0812Z1 ç½‘ç»œç©ºé—´å®‰å…¨ä¸ä¿å¯† (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="è®¡ç®—æœºæŠ€æœ¯">
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (01è®¡ç®—æœºæŠ€æœ¯)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (02ä¸‰äºš)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (03ä¸‡é‡Œå­¦é™¢è”åŸ¹)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (04ä¸­æ³•åŒç¡•å£«)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (05ä¸­æ–°åŒç¡•å£«)
              </option>
              <option value="085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†)">
                085404 è®¡ç®—æœºæŠ€æœ¯ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="è½¯ä»¶å·¥ç¨‹">
              <option value="085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†)">
                085405 è½¯ä»¶å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="äººå·¥æ™ºèƒ½">
              <option value="085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)">
                085410 äººå·¥æ™ºèƒ½ (01äººå·¥æ™ºèƒ½)
              </option>
              <option value="085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)">
                085410 äººå·¥æ™ºèƒ½ (02ä¸‰äºš)
              </option>
              <option value="085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†)">
                085410 äººå·¥æ™ºèƒ½ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹">
              <option value="085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†)">
                085411 å¤§æ•°æ®æŠ€æœ¯ä¸å·¥ç¨‹ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
            <optgroup label="ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨">
              <option value="085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†)">
                085412 ç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ (00ä¸åŒºåˆ†æ–¹å‘)
              </option>
            </optgroup>
          </select>
        </div>

        <div class="input-group">
          <label>æ”¿æ²»</label
          ><input type="number" id="sub1" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>è‹±è¯­</label
          ><input type="number" id="sub2" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>æ•°å­¦</label
          ><input type="number" id="sub3" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>
        <div class="input-group">
          <label>ä¸“ä¸šè¯¾(408)</label
          ><input type="number" id="sub4" placeholder="è¾“å…¥åˆ†æ•°" />
        </div>

        <button id="submitBtn" onclick="submitCloudScore()">æäº¤æˆç»©</button>
      </div>

      <div id="step3" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          å®æ—¶æ€»åˆ†æ’è¡Œæ¦œ
        </h3>

        <div
          class="input-group"
          style="background: #e9f2fb; padding: 10px; border-radius: 6px"
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >å½“å‰æ¦œå•ä¸“ä¸šæ–¹å‘ï¼š</label
          >
          <select
            id="rankFilter"
            onchange="fetchRanking()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div id="rankingList" style="margin-top: 15px; font-size: 14px">
          æ­£åœ¨åŠªåŠ›ä»äº‘ç«¯æ‹‰å–æ’åæ•°æ®...
        </div>

        <button
          id="modifyBtn"
          onclick="goToModify()"
          style="background-color: #e67e22; margin-top: 20px"
        >
          å‘ç°å¡«é”™ï¼Ÿè¿”å›ä¿®æ”¹æˆç»©
        </button>
        <button
          onclick="showCharts()"
          style="background-color: #27ae60; margin-top: 10px"
        >
          æŸ¥çœ‹æˆç»©è¶‹åŠ¿å›¾è¡¨
        </button>
        <button
          onclick="logout()"
          style="background-color: #7f8c8d; margin-top: 10px"
        >
          å®‰å…¨é€€å‡ºå½“å‰ QQ
        </button>
      </div>

      <div id="step4" class="step-box">
        <h3
          style="
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            margin-bottom: 10px;
          "
        >
          æˆç»©è¶‹åŠ¿å›¾è¡¨
        </h3>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ä¸“ä¸šæ–¹å‘ï¼š</label
          >
          <select
            id="chartMajorSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          ></select>
        </div>

        <div
          class="input-group"
          style="
            background: #e9f2fb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
          "
        >
          <label style="color: #0056b3; font-size: 12px; margin-bottom: 4px"
            >é€‰æ‹©ç§‘ç›®ï¼š</label
          >
          <select
            id="chartSubjectSelect"
            onchange="updateChart()"
            style="padding: 6px; font-size: 13px"
          >
            <option value="total">æ€»åˆ†</option>
            <option value="s1">æ”¿æ²»</option>
            <option value="s2">è‹±è¯­</option>
            <option value="s3">æ•°å­¦</option>
            <option value="s4">ä¸“ä¸šè¯¾(408)</option>
          </select>
        </div>

        <div
          id="chartContainer"
          style="width: 100%; height: 400px; margin-top: 20px; min-width: 300px"
        ></div>

        <button
          onclick="showStep(3)"
          style="background-color: #7f8c8d; margin-top: 20px"
        >
          è¿”å›æ’åé¡µé¢
        </button>
      </div>
    </div>

    <script>
      document.getElementById("rankFilter").innerHTML =
        document.getElementById("majorSelect").innerHTML;

      // å…¨å±€å˜é‡ç®¡ç†ç”¨æˆ·çŠ¶æ€ï¼ˆçº¯å†…å­˜ï¼Œåˆ·æ–°å³ä¸¢ï¼Œç»å¯¹ä¸ç¼“å­˜åˆ°ç¡¬ç›˜ï¼‰
      let globalUserQQ = "";
      let globalRecordId = "";

      // åç«¯APIåœ°å€
      const API_BASE_URL = "http://47.105.33.142:8080/api/score";

      // é€šç”¨APIè¯·æ±‚å‡½æ•°
      async function apiRequest(endpoint, method = "GET", data = null) {
        const url = `${API_BASE_URL}${endpoint}`;
        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "omit",
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error("APIè¯·æ±‚é”™è¯¯:", error);
          // CORSé”™è¯¯å¤„ç†
          if (error.message.includes("CORS")) {
            console.error("CORSé”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯APIå·²é…ç½®æ­£ç¡®çš„CORSè®¾ç½®");
            // å°è¯•ä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºé™çº§æ–¹æ¡ˆ
            throw new Error("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
          }
          throw error;
        }
      }

      // ç”¨æˆ·ç™»å½•ä¸æ•°æ®è·å–
      async function loginUser(qq) {
        return apiRequest("/login", "POST", { qq });
      }

      // æäº¤æˆ–æ›´æ–°æˆç»©
      async function submitScore(data) {
        return apiRequest("/submit", "POST", data);
      }

      // è·å–æ’å
      async function getRanking(major) {
        return apiRequest(`/ranking?major=${encodeURIComponent(major)}`);
      }

      // è·å–å›¾è¡¨æ•°æ®
      async function getChartData(major) {
        return apiRequest(`/chart?major=${encodeURIComponent(major)}`);
      }

      function showStep(stepNumber) {
        document
          .querySelectorAll(".step-box")
          .forEach((el) => el.classList.remove("active-step"));
        document
          .getElementById("step" + stepNumber)
          .classList.add("active-step");
      }

      // ç™»å½•æ ¸å¿ƒé€»è¾‘ï¼šä»MySQLè·å–æ•°æ®
      async function loginWithQQ() {
        let qq = document.getElementById("loginQQ").value;
        if (!qq || qq.length < 5) {
          alert("è¯·è¾“å…¥æ­£ç¡®çš„QQå·ï¼");
          return;
        }

        let btn = document.getElementById("loginBtn");
        btn.innerText = "æ­£åœ¨æ ¸å¯¹æ¡£æ¡ˆ...";
        btn.disabled = true;

        try {
          // ä»MySQLæ•°æ®åº“è·å–æ•°æ®
          const res = await loginUser(qq);
          globalUserQQ = qq;
          document.getElementById("displayQQ").innerText = qq;

          // åªè¦æ•°æ®åº“æŸ¥åˆ°æ•°æ®ï¼Œå°±æ˜¯è€ç”¨æˆ·
          if (res.success && res.data) {
            let myData = res.data;
            globalRecordId = myData.qqNumber; // ä½¿ç”¨qqNumberä½œä¸ºè®°å½•ID

            document.getElementById("majorSelect").value = myData.examDirection;
            document.getElementById("sub1").value = myData.politicsScore;
            document.getElementById("sub2").value = myData.englishScore;
            document.getElementById("sub3").value = myData.mathScore;
            document.getElementById("sub4").value = myData.professionalScore;

            document.getElementById("rankFilter").value = myData.examDirection;
            showStep(3);
            fetchRanking();
          }
          // æ•°æ®åº“æ²¡æŸ¥åˆ°ï¼ŒæŒ‰æ–°ç”¨æˆ·å¤„ç†
          else {
            globalRecordId = "";
            // æ¸…ç©ºè¡¨æ ¼ï¼Œé˜²æ­¢ä¸Šä¸€ä¸ªäººçš„ç—•è¿¹ä¸²åœº
            document.getElementById("majorSelect").value = "";
            document.getElementById("sub1").value = "";
            document.getElementById("sub2").value = "";
            document.getElementById("sub3").value = "";
            document.getElementById("sub4").value = "";

            showStep(2);
          }
        } catch (err) {
          console.error("MySQLæŸ¥è¯¢å¤±è´¥:", err);
          alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
        } finally {
          btn.innerText = "è¿›å…¥ç³»ç»Ÿ";
          btn.disabled = false;
        }
      }

      function goToModify() {
        document.getElementById("submitBtn").innerText = "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤";
        document.getElementById("submitBtn").disabled = false;
        showStep(2);
      }

      async function submitCloudScore() {
        let major = document.getElementById("majorSelect").value;
        let v1 = document.getElementById("sub1").value;
        let v2 = document.getElementById("sub2").value;
        let v3 = document.getElementById("sub3").value;
        let v4 = document.getElementById("sub4").value;

        if (!major) {
          alert("è¯·é€‰æ‹©æŠ¥è€ƒä¸“ä¸šä¸æ–¹å‘ï¼");
          return;
        }
        if (v1 === "" || v2 === "" || v3 === "" || v4 === "") {
          alert("æ¯ä¸€ç§‘æˆç»©éƒ½å¿…é¡»å¡«å†™å“¦ï¼");
          return;
        }

        let politics = Number(v1);
        let english = Number(v2);
        let math = Number(v3);
        let professional = Number(v4);
        let total = politics + english + math + professional;

        let btn = document.getElementById("submitBtn");
        btn.innerText = "æ•°æ®ä¼ è¾“ä¸­...";
        btn.disabled = true;

        // ä¿å­˜åˆ°MySQLæ•°æ®åº“
        const scoreData = {
          qq: globalUserQQ,
          major: major,
          politics: politics,
          english: english,
          math: math,
          professional: professional,
          total: total,
          is_deleted: 1, // é»˜è®¤åˆ é™¤çŠ¶æ€
        };

        try {
          const res = await submitScore(scoreData);
          if (res.success) {
            if (!globalRecordId) {
              globalRecordId = globalUserQQ;
              alert("åˆè¯•æˆç»©å½•å…¥æˆåŠŸï¼");
            } else {
              alert("æˆç»©å·²æˆåŠŸæ›´æ–°ï¼");
            }

            document.getElementById("rankFilter").value = major;
            showStep(3);
            fetchRanking();
          } else {
            throw new Error(res.message || "ä¿å­˜å¤±è´¥");
          }
        } catch (err) {
          console.error("MySQLä¿å­˜å¤±è´¥:", err);
          alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
        } finally {
          btn.innerText = globalRecordId ? "ç¡®è®¤ä¿®æ”¹å¹¶é‡æ–°æäº¤" : "æäº¤æˆç»©";
          btn.disabled = false;
        }
      }

      async function fetchRanking() {
        let selectedMajor = document.getElementById("rankFilter").value;
        let rankDiv = document.getElementById("rankingList");
        rankDiv.innerHTML = "æ­£åœ¨æ‹‰å– " + selectedMajor + " çš„æ’å...";

        try {
          // ä»MySQLæ•°æ®åº“è·å–æ•°æ®
          const res = await getRanking(selectedMajor);
          if (res.success && res.data) {
            // è½¬æ¢æ•°æ®æ ¼å¼ï¼Œé€‚é…å‰ç«¯æ˜¾ç¤ºå¹¶è¿‡æ»¤isDeletedä¸º0çš„æ•°æ®
            const records = res.data
              .filter((item) => item.isDeleted === 0)
              .map((item) => ({
                qq: item.qqNumber,
                major: item.examDirection,
                s1: item.politicsScore,
                s2: item.englishScore,
                s3: item.mathScore,
                s4: item.professionalScore,
                total: item.totalScore,
              }));
            displayRanking(records, rankDiv, selectedMajor);
          } else {
            throw new Error("è·å–æ’åå¤±è´¥");
          }
        } catch (err) {
          console.error("MySQLæ’åè·å–å¤±è´¥:", err);
          rankDiv.innerHTML = "æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
        }
      }

      // æ˜¾ç¤ºæ’å
      function displayRanking(records, rankDiv, selectedMajor) {
        let htmlStr = "";
        if (records.length === 0) {
          rankDiv.innerHTML = `<div style="text-align:center; color:#999; margin-top:20px;">è¯¥æ–¹å‘ç›®å‰è¿˜æ²¡æœ‰äººå½•å…¥æˆç»©ï¼Œå¿«æ¥æŠ¢å æ²™å‘ï¼</div>`;
          return;
        }

        records.forEach((item, index) => {
          // åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰ç™»å½•çš„ QQ å·ï¼Œé«˜äº®æ˜¾ç¤ºè‡ªå·±çš„æˆç»©
          let isMe = item.qq === globalUserQQ;
          let bgStyle = isMe
            ? "background: #fff3cd; border-left: 5px solid #f39c12;"
            : "";
          let meTag = isMe
            ? `<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">æˆ‘</span>`
            : "";

          htmlStr += `
                <div class="rank-item" style="${bgStyle}">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="rank-detail">
                        <strong>æ€»åˆ†ï¼š<span style="color:#e74c3c; font-size:16px;">${item.total}</span></strong> ${meTag}<br>
                        <span style="font-size:12px; color:#555;">æ”¿:${item.s1} | è‹±:${item.s2} | æ•°:${item.s3} | 408:${item.s4}</span>
                    </div>
                </div>
            `;
        });
        rankDiv.innerHTML = htmlStr;
      }

      // é€€å‡ºæ¸…ç©ºå†…å­˜çŠ¶æ€ï¼Œå›å½’åˆå§‹
      function logout() {
        globalUserQQ = "";
        globalRecordId = "";
        document.getElementById("loginQQ").value = "";
        showStep(1);
      }

      // æ˜¾ç¤ºå›¾è¡¨é¡µé¢
      function showCharts() {
        // åˆå§‹åŒ–å›¾è¡¨ä¸“ä¸šé€‰æ‹©å™¨
        document.getElementById("chartMajorSelect").innerHTML =
          document.getElementById("majorSelect").innerHTML;
        // é»˜è®¤ä¸ºå½“å‰é€‰æ‹©çš„ä¸“ä¸š
        document.getElementById("chartMajorSelect").value =
          document.getElementById("rankFilter").value;
        // æ˜¾ç¤ºå›¾è¡¨é¡µé¢
        showStep(4);
        // æ›´æ–°å›¾è¡¨
        updateChart();
      }

      // å›¾è¡¨å®ä¾‹
      let chartInstance;

      // æ›´æ–°å›¾è¡¨
      async function updateChart() {
        const selectedMajor = document.getElementById("chartMajorSelect").value;
        const selectedSubject =
          document.getElementById("chartSubjectSelect").value;
        const chartContainer = document.getElementById("chartContainer");

        // ç§‘ç›®åç§°æ˜ å°„
        const subjectNames = {
          total: "æ€»åˆ†",
          s1: "æ”¿æ²»",
          s2: "è‹±è¯­",
          s3: "æ•°å­¦",
          s4: "ä¸“ä¸šè¯¾(408)",
        };

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        if (!chartInstance) {
          chartInstance = echarts.init(chartContainer);
        }

        try {
          // ä»MySQLæ•°æ®åº“è·å–æ•°æ®
          const res = await getChartData(selectedMajor);
          if (res.success && res.data) {
            // è½¬æ¢æ•°æ®æ ¼å¼å¹¶è¿‡æ»¤isDeletedä¸º0çš„æ•°æ®
            const records = res.data
              .filter((item) => item.isDeleted === 0)
              .map((item) => ({
                qq: item.qqNumber,
                major: item.examDirection,
                s1: item.politicsScore,
                s2: item.englishScore,
                s3: item.mathScore,
                s4: item.professionalScore,
                total: item.totalScore,
              }));

            // å¤„ç†æ•°æ®
            const sortedRecords = records.sort(
              (a, b) => a[selectedSubject] - b[selectedSubject],
            );
            const ranks = sortedRecords.map((_, index) => index + 1);
            const scores = sortedRecords.map(
              (record) => record[selectedSubject],
            );
            const names = sortedRecords.map(
              (record) => `#${record.qq.slice(-4)}`,
            );

            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
              title: {
                text:
                  selectedMajor +
                  " " +
                  subjectNames[selectedSubject] +
                  "æˆç»©è¶‹åŠ¿",
                left: "center",
              },
              tooltip: {
                trigger: "axis",
                formatter: function (params) {
                  const index = params[0].dataIndex;
                  return `æ’å: ${ranks[index]}<br/>${subjectNames[selectedSubject]}: ${scores[index]}<br/>ç”¨æˆ·: ${names[index]}`;
                },
              },
              xAxis: {
                type: "category",
                data: ranks,
                name: "æ’å",
                nameLocation: "middle",
                nameGap: 30,
              },
              yAxis: {
                type: "value",
                name: subjectNames[selectedSubject],
                nameLocation: "middle",
                nameGap: 50,
              },
              series: [
                {
                  data: scores,
                  type: "line",
                  smooth: true,
                  symbol: "circle",
                  symbolSize: 8,
                  lineStyle: {
                    width: 3,
                  },
                  itemStyle: {
                    color: "#0056b3",
                  },
                  areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      {
                        offset: 0,
                        color: "rgba(0, 86, 179, 0.3)",
                      },
                      {
                        offset: 1,
                        color: "rgba(0, 86, 179, 0.1)",
                      },
                    ]),
                  },
                },
              ],
            };

            // è®¾ç½®å›¾è¡¨é€‰é¡¹
            chartInstance.setOption(option);
          } else {
            throw new Error("è·å–å›¾è¡¨æ•°æ®å¤±è´¥");
          }
        } catch (err) {
          console.error("MySQLå›¾è¡¨æ•°æ®è·å–å¤±è´¥:", err);
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          chartInstance.setOption({
            title: {
              text: "è·å–æ•°æ®å¤±è´¥",
              left: "center",
            },
            series: [],
          });
        }
      }

      // çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
      window.addEventListener("resize", function () {
        if (chartInstance) {
          chartInstance.resize();
        }
      });
    </script>
  </body>
</html>
